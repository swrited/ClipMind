<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>ClipMind - 从视频片段到结构化思维</title>
    <meta name="description" content="ClipMind - 从视频片段到结构化思维，智能整理你的知识" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- bootstrap CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}" type="text/css" media="all" />
    <!-- carousel CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/owl.carousel.min.css') }}" type="text/css" media="all" />
    <!-- responsive CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive.css') }}" type="text/css" media="all" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/animate.css') }}" type="text/css" media="all" />
    <!-- font-awesome CSS -->
    <link type="text/css" rel="stylesheet" href="{{ url_for('static', filename='css/all.min.css') }}" />
    <!-- font-flaticon CSS -->
    <link type="text/css" rel="stylesheet" href="{{ url_for('static', filename='fonts/flaticon/font/flaticon.css') }}" />
    <!-- theme-default CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme-default.css') }}" type="text/css" media="all" />
    <!-- meanmenu CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/meanmenu.min.css') }}" type="text/css" media="all" />
    <!-- Main Style CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" type="text/css" media="all" />
    <!-- transitions CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/owl.transitions.css') }}" type="text/css" media="all" />
    <!-- widget CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/widget.css') }}" type="text/css" media="all" />
    <!-- Markdown CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css">
    <!-- modernizr js -->
    <script type="text/javascript" src="{{ url_for('static', filename='js/vendor/modernizr-3.5.0.min.js') }}"></script>
    <!-- marked js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      body {
        background-color: #f8f9fa;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }
      .main-content-area {
        padding: 80px 0 50px;
        min-height: calc(100vh - 200px);
      }
      .app-container {
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
        padding: 30px;
        margin-bottom: 30px;
      }
      .app-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        border-bottom: 1px solid #eee;
        padding-bottom: 20px;
      }
      .app-title {
        color: #4fc1f0;
        font-size: 24px;
        font-weight: 600;
        margin: 0;
      }
      .app-subtitle {
        color: #666;
        font-size: 16px;
        margin-top: 5px;
      }
      .upload-section {
        text-align: center;
        margin-bottom: 30px;
        background-color: #f8f9fa;
        padding: 30px;
        border-radius: 10px;
        border: 2px dashed #ddd;
      }
      .file-input {
        display: none;
      }
      .upload-btn {
        display: inline-block;
        background-color: #4fc1f0;
        color: #fff;
        padding: 12px 25px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
      }
      .upload-btn:hover {
        background-color: #151948;
      }
      .file-name {
        margin-top: 10px;
        font-size: 14px;
        color: #666;
      }
      .submit-btn {
        background-color: #151948;
        color: #fff;
        border: none;
        border-radius: 5px;
        padding: 12px 25px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 20px;
      }
      .submit-btn:hover {
        background-color: #4fc1f0;
      }
      .submit-btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .loading {
        text-align: center;
        display: none;
        margin: 20px 0;
      }
      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border-left-color: #09f;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .progress-container {
        margin: 20px 0;
        display: none;
      }
      .progress-bar {
        height: 20px;
        background-color: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
        position: relative;
      }
      .progress-bar-fill {
        height: 100%;
        background-color: #4CAF50;
        border-radius: 10px;
        transition: width 0.3s ease;
        width: 0%;
      }
      .progress-text {
        text-align: center;
        margin-top: 5px;
        font-size: 14px;
        color: #666;
      }
      .results {
        display: none;
        margin-top: 30px;
      }
      .result-section {
        margin-bottom: 30px;
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
        padding: 20px;
      }
      .result-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 15px;
        color: #151948;
        border-left: 4px solid #4fc1f0;
        padding-left: 10px;
      }
      .result-content {
        font-size: 16px;
        line-height: 1.6;
        color: #333;
      }
      .markdown {
        padding: 15px;
        background-color: #f9f9f9;
        border-radius: 5px;
      }
      .markdown h1, .markdown h2, .markdown h3 {
        color: #151948;
      }
      .markdown strong {
        color: #e74c3c;
      }
      .action-buttons {
        margin-top: 20px;
        text-align: center;
      }
      .action-btn {
        background-color: #4fc1f0;
        color: #fff;
        border: none;
        border-radius: 5px;
        padding: 10px 20px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 0 5px;
      }
      .action-btn:hover {
        background-color: #151948;
      }
      .error-message {
        color: #e74c3c;
        margin: 20px 0;
        padding: 15px;
        background-color: #fdf2f2;
        border-radius: 5px;
        border-left: 4px solid #e74c3c;
        display: none;
      }
      .nav-menu {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
      }
      .nav-btn {
        background-color: transparent;
        border: none;
        padding: 10px 20px;
        margin: 0 5px;
        cursor: pointer;
        font-size: 16px;
        border-radius: 5px;
        transition: all 0.3s ease;
      }
      .nav-btn:hover {
        background-color: #f0f0f0;
      }
      .nav-btn.active {
        background-color: #4fc1f0;
        color: white;
      }
      .content-section {
        display: none;
      }
      .content-section.active {
        display: block;
      }
      .chat-container {
        margin-top: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
      }
      .chat-messages {
        height: 300px;
        overflow-y: auto;
        padding: 15px;
        background-color: #f9f9f9;
      }
      .chat-message {
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 8px;
        max-width: 80%;
        word-wrap: break-word;
      }
      .user-message {
        background-color: #e3f2fd;
        margin-left: auto;
        text-align: right;
      }
      .ai-message {
        background-color: #f1f1f1;
        margin-right: auto;
      }
      .chat-input-container {
        display: flex;
        padding: 10px;
        border-top: 1px solid #ddd;
        background-color: white;
      }
      .chat-input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }
      .chat-send-btn {
        margin-left: 10px;
        padding: 10px 15px;
        background-color: #4fc1f0;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .chat-send-btn:hover {
        background-color: #151948;
      }
      .test-questions-content {
        border-left-color: #9b59b6;
      }
      .header-logo {
        display: flex;
        align-items: center;
      }
      .header-logo h3 {
        margin: 0;
        color: #4fc1f0;
        font-weight: 600;
      }
      .header-logo-left {
        color: #4fc1f0;
        margin-right: 10px;
      }
      .header-logo-right {
        color: #151948;
      }
      .header_top_menu_icon ul li {
        display: inline-block;
        margin-left: 15px;
        position: relative;
      }
      .header_top_menu_icon ul li a {
        color: white;
        text-decoration: none;
        font-size: 14px;
        transition: all 0.3s ease;
      }
      .header_top_menu_icon ul li a:hover {
        color: #4fc1f0;
      }
      .active-nav {
        color: #4fc1f0 !important;
        font-weight: bold;
      }
      .dropdown {
        position: relative;
      }
      .dropdown-toggle {
        cursor: pointer;
      }
      .dropdown-menu {
        position: absolute;
        top: 100%;
        right: 0;
        background-color: #fff;
        border-radius: 5px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        padding: 10px 0;
        min-width: 120px;
        display: none;
        z-index: 1000;
      }
      .dropdown:hover .dropdown-menu {
        display: block;
      }
      .dropdown-menu li {
        display: block !important;
        margin: 0 !important;
      }
      .dropdown-menu li a {
        display: block;
        padding: 8px 15px;
        color: #333 !important;
        font-size: 14px;
        transition: all 0.3s ease;
      }
      .dropdown-menu li a:hover {
        background-color: #f8f9fa;
        color: #4fc1f0 !important;
      }
      .header_top_menu {
        background-color: #151948;
        padding: 10px 0;
      }
      .header_top_menu_text p {
        color: white;
        margin: 0;
      }
      .header_top_menu_icon ul {
        list-style: none;
        margin: 0;
        padding: 0;
        text-align: right;
      }
      .header_top_menu_icon ul li {
        display: inline-block;
        margin-left: 15px;
      }
      .header_top_menu_icon ul li a {
        color: white;
        text-decoration: none;
      }
      .footer-area {
        background-color: #151948;
        padding: 20px 0;
        color: white;
      }
      .footer-text p {
        margin: 0;
      }
      .app-welcome {
        text-align: center;
        margin-bottom: 30px;
      }
      .app-welcome h1 {
        font-size: 32px;
        color: #151948;
        margin-bottom: 10px;
      }
      .app-welcome p {
        font-size: 18px;
        color: #666;
      }
      .app-divider {
        height: 4px;
        width: 60px;
        background-color: #4fc1f0;
        margin: 15px auto;
      }
    </style>
  </head>
  <body>

    <!-- Start Header Area -->
    <div class="header_top_menu">
      <div class="container">
        <div class="row">
          <div class="col-lg-6">
            <div class="header_top_menu_address">
              <div class="header_top_menu_text">
                <p>ClipMind - 从视频片段到结构化思维</p>
              </div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="header_top_menu_icon">
              <div class="header_top_menu_icon_inner">
                <ul>
                  <li><a href="{{ url_for('home') }}" class="{% if request.path == url_for('home') %}active-nav{% endif %}">首页</a></li>
                  <li><a href="{{ url_for('index') }}" class="{% if request.path == url_for('index') %}active-nav{% endif %}">使用</a></li>
                  <li class="dropdown">
                    <a href="#" class="dropdown-toggle">{{ username }} <i class="fas fa-caret-down"></i></a>
                    <ul class="dropdown-menu">
                      <li><a href="{{ url_for('profile') }}">个人中心</a></li>
                      <li><a href="{{ url_for('logout') }}">退出登录</a></li>
                    </ul>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Start Main Menu Area -->
    <div id="sticky-header" class="cyber_nav_manu d-md-none d-lg-block d-sm-none d-none">
      <div class="container">
        <div class="row">
          <div class="col-md-12">
            <!-- Logo removed as requested -->
          </div>
        </div>
      </div>
    </div>
    <div class="mobile-menu-area d-sm-block d-md-block d-lg-none">
      <div class="mobile-menu">
        <nav class="cyber_menu">
          <ul>
            <li><a href="{{ url_for('home') }}">首页</a></li>
            <li><a href="{{ url_for('index') }}">使用</a></li>
            <li><a href="{{ url_for('profile') }}">个人中心</a></li>
            <li><a href="{{ url_for('logout') }}">退出登录</a></li>
          </ul>
        </nav>
      </div>
    </div>
    <!-- End Main Menu Area -->

    <!-- Start Main Content Area -->
    <div class="main-content-area" id="home">
      <div class="container">
        <div class="row">
          <div class="col-lg-12">
            <div class="app-container">
              <div class="app-header">


              </div>

              <div class="app-welcome">
                <h1>ClipMind</h1>
                <div class="app-divider"></div>
                <p>从视频片段到结构化思维，智能整理你的知识</p>
              </div>

              <div class="upload-section">
                <label for="file-upload" class="upload-btn">
                  选择音频或视频文件
                </label>
                <input id="file-upload" type="file" class="file-input" accept=".mp3,.wav,.ogg,.m4a,.mp4,.avi,.mov,.mkv">
                <div id="file-name" class="file-name">未选择文件</div>
              </div>

              <div class="text-center">
                <button id="submit-btn" class="submit-btn" disabled>开始处理</button>
              </div>

              <div id="progress-container" class="progress-container">
                <div class="progress-bar">
                  <div id="progress-bar-fill" class="progress-bar-fill"></div>
                </div>
                <div id="progress-text" class="progress-text">准备中...</div>
              </div>

              <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>正在处理中，请稍候...</p>
              </div>

              <div id="error-message" class="error-message"></div>

              <div class="action-buttons" style="margin-top: 20px; margin-bottom: 20px;">
                <button id="export-md-btn" class="action-btn">导出为Markdown</button>
                <button id="export-txt-btn" class="action-btn">导出为纯文本</button>
              </div>

              <div id="results" class="results">
                <!-- 导航菜单 -->
                <div class="nav-menu">
                  <button class="nav-btn active" data-target="summary-section">内容总结</button>
                  <button class="nav-btn" data-target="keywords-section">关键词和大致框架</button>
                  <button class="nav-btn" data-target="test-section">课堂测试</button>
                </div>

                <div id="summary-section" class="result-section content-section active">
                  <div class="result-title">内容总结:</div>
                  <div id="summary" class="result-content summary-content markdown"></div>
                </div>

                <div id="keywords-section" class="result-section content-section">
                  <div class="result-title">关键词和大致框架:</div>
                  <div id="keywords-framework" class="result-content key-points-content markdown"></div>
                </div>

                <div id="test-section" class="result-section content-section">
                  <div class="result-title">课堂测试:</div>
                  <div id="test-questions" class="result-content test-questions-content markdown"></div>

                  <div id="chat-container" class="chat-container">
                    <div id="chat-messages" class="chat-messages"></div>
                    <div class="chat-input-container">
                      <input type="text" id="chat-input" class="chat-input" placeholder="输入你的回答或问题...">
                      <button id="chat-send-btn" class="chat-send-btn">发送</button>
                    </div>
                  </div>
                </div>

                <div class="result-section" style="display: none;">
                  <div id="original-text" class="result-content markdown"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- End Main Content Area -->

    <!-- Start Footer Area -->
    <div class="footer-area">
      <div class="container">
        <div class="row">
          <div class="col-lg-12">
            <div class="footer-text text-center">
              <p>© 2025 ClipMind. 保留所有权利.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- End Footer Area -->

    <!-- jquery js -->
    <script src="{{ url_for('static', filename='js/vendor/jquery-3.2.1.min.js') }}"></script>
    <!-- bootstrap js -->
    <script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
    <!-- carousel js -->
    <script src="{{ url_for('static', filename='js/owl.carousel.min.js') }}"></script>
    <!-- counterup js -->
    <script src="{{ url_for('static', filename='js/jquery.counterup.min.js') }}"></script>
    <!-- waypoints js -->
    <script src="{{ url_for('static', filename='js/waypoints.min.js') }}"></script>
    <!-- wow js -->
    <script src="{{ url_for('static', filename='js/wow.js') }}"></script>
    <!-- imagesloaded js -->
    <script src="{{ url_for('static', filename='js/imagesloaded.pkgd.min.js') }}"></script>
    <!-- main js -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // 存储原始数据
        const rawData = {};

        // 获取DOM元素
        const fileUpload = document.getElementById('file-upload');
        const fileName = document.getElementById('file-name');
        const submitBtn = document.getElementById('submit-btn');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const originalText = document.getElementById('original-text');
        const summary = document.getElementById('summary');
        const errorMessage = document.getElementById('error-message');
        const exportMdBtn = document.getElementById('export-md-btn');
        const exportTxtBtn = document.getElementById('export-txt-btn');
        const progressContainer = document.getElementById('progress-container');
        const progressBarFill = document.getElementById('progress-bar-fill');
        const progressText = document.getElementById('progress-text');

        // 绑定导航菜单事件
        const navButtons = document.querySelectorAll('.nav-btn');
        navButtons.forEach(button => {
            button.addEventListener('click', function() {
                // 移除所有按钮的active类
                navButtons.forEach(btn => btn.classList.remove('active'));
                // 给当前点击的按钮添加active类
                this.classList.add('active');

                // 隐藏所有内容区域
                const contentSections = document.querySelectorAll('.content-section');
                contentSections.forEach(section => section.classList.remove('active'));

                // 显示对应的内容区域
                const targetId = this.getAttribute('data-target');
                document.getElementById(targetId).classList.add('active');
            });
        });

        // 绑定文件上传事件
        fileUpload.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                fileName.textContent = this.files[0].name;
                submitBtn.disabled = false;
            } else {
                fileName.textContent = '未选择文件';
                submitBtn.disabled = true;
            }
        });

        // 绑定提交按钮事件
        submitBtn.addEventListener('click', function() {
            if (!fileUpload.files || !fileUpload.files[0]) {
                return;
            }

            const file = fileUpload.files[0];
            const formData = new FormData();
            formData.append('file', file);

            // 隐藏结果和错误信息
            results.style.display = 'none';
            errorMessage.style.display = 'none';

            // 显示进度条
            progressContainer.style.display = 'block';
            progressBarFill.style.width = '0%';
            progressText.textContent = '准备中...';

            // 禁用提交按钮
            submitBtn.disabled = true;

            // 第一步：上传文件并获取任务ID
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || '上传文件时出错');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (!data.task_id) {
                    throw new Error('服务器未返回任务ID');
                }

                const taskId = data.task_id;

                // 更新进度条
                progressBarFill.style.width = '5%';
                progressText.textContent = '文件已上传，开始处理...';

                // 启动进度轮询
                const progressInterval = pollProgress(taskId);

                // 第二步：开始处理任务
                return fetch(`/process/${taskId}?file=${encodeURIComponent(file.name)}`)
                    .finally(() => {
                        // 无论成功还是失败，都清除轮询
                        clearInterval(progressInterval);
                    });
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || '处理文件时出错');
                    });
                }
                return response.json();
            })
            .then(data => {
                // 隐藏进度条
                progressContainer.style.display = 'none';

                // 存储原始数据
                rawData.original_text = data.original_text;
                rawData.summary = data.summary;
                rawData.keywords_and_framework = data.keywords_and_framework || '';
                rawData.test_questions = data.test_questions || '';
                rawData.history_id = data.history_id || null;

                // 转换为Markdown并显示结果
                originalText.innerHTML = marked.parse(formatToMarkdown(rawData.original_text));
                summary.innerHTML = marked.parse(formatToMarkdown(rawData.summary));

                // 显示AI生成的关键词和框架
                document.getElementById('keywords-framework').innerHTML = marked.parse(rawData.keywords_and_framework);

                // 显示测试问题
                document.getElementById('test-questions').innerHTML = marked.parse(rawData.test_questions);

                // 初始化聊天界面
                initChat();

                results.style.display = 'block';

                // 检查是否有语音识别错误
                if (data.original_text.includes("无法识别音频内容") ||
                    data.original_text.includes("无法连接到语音识别服务")) {
                    errorMessage.textContent = "警告：语音识别服务出现问题，可能影响结果质量。请检查网络连接或尝试使用不同的音频文件。";
                    errorMessage.style.display = 'block';
                }

                // Re-enable submit button
                submitBtn.disabled = false;
            })
            .catch(error => {
                // 隐藏进度条和加载动画
                progressContainer.style.display = 'none';
                loading.style.display = 'none';

                // 显示错误信息
                errorMessage.textContent = error.message;
                errorMessage.style.display = 'block';

                // 重新启用提交按钮
                submitBtn.disabled = false;
            });
        });

        // 添加进度轮询功能
        function pollProgress(taskId) {
            const pollInterval = setInterval(() => {
                fetch(`/progress/${taskId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'completed' || data.status === 'error') {
                            clearInterval(pollInterval);
                            return;
                        }

                        // 更新进度条
                        progressBarFill.style.width = `${data.progress}%`;
                        progressText.textContent = data.message;
                    })
                    .catch(error => {
                        console.error('轮询进度时出错:', error);
                    });
            }, 1000); // 每秒轮询一次

            return pollInterval;
        }

        // 聊天功能
        function initChat() {
            const chatInput = document.getElementById('chat-input');
            const chatSendBtn = document.getElementById('chat-send-btn');
            const chatMessages = document.getElementById('chat-messages');

            // 清空聊天历史
            let chatHistory = [];
            chatMessages.innerHTML = '';

            // 添加欢迎消息
            addMessage('欢迎来到课堂测试！我是你的AI助教，可以回答你关于内容的问题，也可以测试你对内容的理解。请随时提问或回答上面的测试问题。', 'ai');

            // 绑定发送按钮事件
            chatSendBtn.onclick = sendMessage;

            // 绑定输入框回车事件
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // 发送消息函数
            function sendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;

                // 添加用户消息到聊天界面
                addMessage(message, 'user');

                // 清空输入框
                chatInput.value = '';

                // 添加用户消息到历史记录
                chatHistory.push({
                    role: 'user',
                    content: message
                });

                // 显示AI正在输入的提示
                const typingIndicator = document.createElement('div');
                typingIndicator.className = 'chat-message ai-message';
                typingIndicator.id = 'typing-indicator';
                typingIndicator.textContent = '正在思考...';
                chatMessages.appendChild(typingIndicator);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // 发送请求到服务器
                fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        chat_history: chatHistory,
                        context: {
                            original_text: rawData.original_text,
                            summary: rawData.summary,
                            test_questions: rawData.test_questions,
                            history_id: rawData.history_id
                        }
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('网络请求失败');
                    }
                    return response.json();
                })
                .then(data => {
                    // 移除正在输入的提示
                    const typingIndicator = document.getElementById('typing-indicator');
                    if (typingIndicator) {
                        typingIndicator.remove();
                    }

                    // 添加AI回复到聊天界面
                    addMessage(data.response, 'ai');

                    // 添加AI回复到历史记录
                    chatHistory.push({
                        role: 'assistant',
                        content: data.response
                    });
                })
                .catch(error => {
                    console.error('聊天请求出错:', error);

                    // 移除正在输入的提示
                    const typingIndicator = document.getElementById('typing-indicator');
                    if (typingIndicator) {
                        typingIndicator.remove();
                    }

                    // 显示错误消息
                    addMessage('抱歉，发生了错误，请稍后再试。', 'ai');
                });
            }

            // 添加消息到聊天界面
            function addMessage(message, role) {
                const messageElement = document.createElement('div');
                messageElement.className = `chat-message ${role}-message`;

                // 使用marked解析消息中的Markdown
                messageElement.innerHTML = marked.parse(message);

                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        // 辅助函数：格式化为Markdown
        function formatToMarkdown(text) {
            if (!text) return '';
            return text.replace(/\n/g, '\n\n');
        }

        // 辅助函数：生成完整的Markdown文档
        function generateMarkdownDocument(data) {
            const filename = fileName.textContent || '未命名文件';
            const date = new Date().toLocaleDateString();

            let md = `# ${filename} 转录与总结\n\n`;
            md += `*生成日期: ${date}*\n\n`;

            md += '## 内容总结\n\n';
            md += formatToMarkdown(data.summary);

            md += '\n\n';
            md += data.keywords_and_framework;

            return md;
        }

        // 辅助函数：生成纯文本文档
        function generateTextDocument(data) {
            const filename = fileName.textContent || '未命名文件';
            const date = new Date().toLocaleDateString();

            let txt = `${filename} 转录与总结\n`;
            txt += `生成日期: ${date}\n\n`;

            txt += '内容总结:\n\n';
            txt += data.summary;

            txt += '\n\n关键词和大致框架:\n\n';
            // 移除Markdown标记
            txt += data.keywords_and_framework.replace(/#+\s|[*_`]/g, '').replace(/- /g, '• ');

            return txt;
        }

        // 辅助函数：下载文件
        function downloadFile(filename, content, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        }

        // 绑定导出按钮事件
        exportMdBtn.addEventListener('click', function() {
            const mdContent = generateMarkdownDocument(rawData);
            downloadFile(`${fileName.textContent || '未命名文件'}_转录与总结.md`, mdContent, 'text/markdown');
        });

        exportTxtBtn.addEventListener('click', function() {
            const txtContent = generateTextDocument(rawData);
            downloadFile(`${fileName.textContent || '未命名文件'}_转录与总结.txt`, txtContent, 'text/plain');
        });
      });
    </script>
  </body>
</html>
